from json import dumps
import logging
import os
import traceback

from requests import Session
from requests.exceptions import HTTPError

from pingfedsdk.exceptions import BadRequest
from pingfedsdk.exceptions import NotFound
from pingfedsdk.exceptions import ObjectDeleted
from pingfedsdk.exceptions import ValidationError
from pingfedsdk.models.api_result import ApiResult as ModelApiResult
from pingfedsdk.models.local_identity_profile import LocalIdentityProfile as ModelLocalIdentityProfile
from pingfedsdk.models.local_identity_profiles import LocalIdentityProfiles as ModelLocalIdentityProfiles


class LocalIdentityIdentityProfiles:
    def __init__(self, endpoint: str, session: Session) -> None:
        logging.basicConfig(format="%(asctime)s [%(levelname)s] (%(funcName)s) %(message)s", datefmt="%m/%d/%Y %I:%M:%S %p")
        self.logger = logging.getLogger("PingSDK.LocalIdentityIdentityProfiles")
        self.logger.setLevel(int(os.environ.get("Logging", logging.DEBUG)))
        self.endpoint = endpoint
        self.session = session

    def _build_uri(self, path: str):
        return f"{self.endpoint}{path}"

    def getIdentityProfiles(self, apcId: str = None, filter: str = None, numberPerPage: int = None, page: int = None):
        """ Get the list of configured local identity profiles.
        """

        try:
            response = self.session.get(
                url=self._build_uri("/localIdentity/identityProfiles"),
                headers={"Content-Type": "application/json"}
            )
        except HTTPError as http_err:
            print(traceback.format_exc())
            self.logger.error(f"HTTP error occurred: {http_err}")
            raise http_err
        except Exception as err:
            print(traceback.format_exc())
            self.logger.error(f"Error occurred: {err}")
            raise err
        else:
            if response.status_code == 200:
                self.logger.info("Success.")
                if isinstance(response.json(), list):
                    response_dict = {'items': response.json()}
                    return ModelLocalIdentityProfiles.from_dict(response_dict)
                else:
                    return ModelLocalIdentityProfiles.from_dict(response.json())
            if response.status_code == 422:
                raise ValidationError(response.json())

    def createIdentityProfile(self, body: ModelLocalIdentityProfile, XBypassExternalValidation: bool = None):
        """ Create a new local identity profile.
        """

        try:
            response = self.session.post(
                data=dumps({x: y for x, y in body.to_dict().items() if y is not None}),
                url=self._build_uri("/localIdentity/identityProfiles"),
                headers={"Content-Type": "application/json"}
            )
        except HTTPError as http_err:
            print(traceback.format_exc())
            self.logger.error(f"HTTP error occurred: {http_err}")
            raise http_err
        except Exception as err:
            print(traceback.format_exc())
            self.logger.error(f"Error occurred: {err}")
            raise err
        else:
            if response.status_code == 201:
                self.logger.info("Local identity profile created.")
                if isinstance(response.json(), list):
                    response_dict = {'items': response.json()}
                    return ModelLocalIdentityProfile.from_dict(response_dict)
                else:
                    return ModelLocalIdentityProfile.from_dict(response.json())
            if response.status_code == 400:
                message = "(400) The request was improperly formatted or contained invalid fields."
                self.logger.info(message)
                raise BadRequest(message)
            if response.status_code == 422:
                raise ValidationError(response.json())

    def getIdentityProfile(self, id: str):
        """ Get the local identity profile by ID.
        """

        try:
            response = self.session.get(
                url=self._build_uri(f"/localIdentity/identityProfiles/{id}"),
                headers={"Content-Type": "application/json"}
            )
        except HTTPError as http_err:
            print(traceback.format_exc())
            self.logger.error(f"HTTP error occurred: {http_err}")
            raise http_err
        except Exception as err:
            print(traceback.format_exc())
            self.logger.error(f"Error occurred: {err}")
            raise err
        else:
            if response.status_code == 200:
                self.logger.info("Success.")
                if isinstance(response.json(), list):
                    response_dict = {'items': response.json()}
                    return ModelLocalIdentityProfile.from_dict(response_dict)
                else:
                    return ModelLocalIdentityProfile.from_dict(response.json())
            if response.status_code == 404:
                message = "(404) Resource not found."
                self.logger.info(message)
                raise NotFound(message)

    def updateIdentityProfile(self, body: ModelLocalIdentityProfile, id: str, XBypassExternalValidation: bool = None):
        """ Update the local identity profile by ID.
        """

        try:
            response = self.session.put(
                data=dumps({x: y for x, y in body.to_dict().items() if y is not None}),
                url=self._build_uri(f"/localIdentity/identityProfiles/{id}"),
                headers={"Content-Type": "application/json"}
            )
        except HTTPError as http_err:
            print(traceback.format_exc())
            self.logger.error(f"HTTP error occurred: {http_err}")
            raise http_err
        except Exception as err:
            print(traceback.format_exc())
            self.logger.error(f"Error occurred: {err}")
            raise err
        else:
            if response.status_code == 200:
                self.logger.info("Local identity profile updated.")
                if isinstance(response.json(), list):
                    response_dict = {'items': response.json()}
                    return ModelLocalIdentityProfile.from_dict(response_dict)
                else:
                    return ModelLocalIdentityProfile.from_dict(response.json())
            if response.status_code == 400:
                message = "(400) The request was improperly formatted or contained invalid fields."
                self.logger.info(message)
                raise BadRequest(message)
            if response.status_code == 404:
                message = "(404) Resource not found."
                self.logger.info(message)
                raise NotFound(message)
            if response.status_code == 422:
                raise ValidationError(response.json())

    def deleteIdentityProfile(self, id: str):
        """ Delete the local identity profile by ID.
        """

        try:
            response = self.session.delete(
                url=self._build_uri(f"/localIdentity/identityProfiles/{id}"),
                headers={"Content-Type": "application/json"}
            )
        except HTTPError as http_err:
            print(traceback.format_exc())
            self.logger.error(f"HTTP error occurred: {http_err}")
            raise http_err
        except Exception as err:
            print(traceback.format_exc())
            self.logger.error(f"Error occurred: {err}")
            raise err
        else:
            if response.status_code == 204:
                self.logger.info("Local identity profile deleted.")
                return ModelApiResult(message="Local identity profile deleted.", validationErrors=[])
            if response.status_code == 404:
                message = "(404) Resource not found."
                self.logger.info(message)
                raise NotFound(message)
            if response.status_code == 422:
                raise ValidationError(response.json())
